//: A UIKit based Playground for presenting user interface
  
import UIKit
import PlaygroundSupport

class LabelCell: UICollectionViewCell {
    static let name = String(describing: self)
    
    lazy var label = makeLabel()
    
    override init(frame: CGRect) {
        super.init(frame: frame)

        contentView.backgroundColor = .blue
        
        label.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(label)
        NSLayoutConstraint.activate([
            label.topAnchor.constraint(equalTo: contentView.topAnchor),
            label.leadingAnchor.constraint(equalTo: contentView.leadingAnchor),
            label.bottomAnchor.constraint(equalTo: contentView.bottomAnchor),
            label.trailingAnchor.constraint(equalTo: contentView.trailingAnchor),
        ])
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    func update(text: String) {
        label.text = text
    }
    
    func makeLabel() -> UILabel {
        let label = UILabel()
        label.backgroundColor = .green
        label.numberOfLines = 0
        return label
    }
}

class BackgroundColorView: UICollectionReusableView {
    static let name = String(describing: self)
    static let kind = name
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        
        backgroundColor = .yellow
    }

    @available(*, unavailable)
    public required init?(coder: NSCoder) {
        fatalError()
    }
}

class MyViewController : UIViewController {
    struct Item: Hashable {
        let id = UUID()
        let value: String = (1...((1...100).randomElement() ?? 1))
            .map(String.init)
            .joined(separator: ",")
    }
    typealias Section = Int
    typealias DataSource = UICollectionViewDiffableDataSource<Section, Item>
    typealias Snapshot = NSDiffableDataSourceSnapshot<Section, Item>
    
    let items: [Item] = (0..<5).map { _ in .init() }
    
    lazy var collectionView = makeCollectionView()
    lazy var dataSource = DataSource(
        collectionView: collectionView,
        cellProvider: makeCellProvider()
    )
    
    override func loadView() {
        self.view = collectionView
        apply()
    }
    
    func makeCollectionView() -> UICollectionView {
        let collectionView = UICollectionView(
            frame: .zero,
            collectionViewLayout: makeLayout()
        )
        collectionView.backgroundColor = .white
        collectionView.register(
            LabelCell.self,
            forCellWithReuseIdentifier: LabelCell.name
        )
        return collectionView
    }

    // MARK: - Diffable Data Sources
    func makeCellProvider() -> DataSource.CellProvider {
        return { collectionView, indexPath, item in
            let cell = collectionView.dequeueReusableCell(
                withReuseIdentifier: LabelCell.name,
                for: indexPath
            )
            (cell as? LabelCell)?.update(text: item.value)
            return cell
        }
    }
    
    func apply() {
        var snapshot = Snapshot()
        snapshot.appendSections([0])
        snapshot.appendItems(items, toSection: 0)
        dataSource.apply(snapshot)
    }
    
    // MARK: - Compositional Layouts
    func makeLayout() -> UICollectionViewLayout {
        let layout = UICollectionViewCompositionalLayout(section: makeLayoutSection_example2_1())
        layout.register(
            BackgroundColorView.self,
            forDecorationViewOfKind: BackgroundColorView.kind
        )
        return layout
    }
    
    /// „ÅØ„Åæ„Çä„Å©„Åì„ÇçÔºë: itemSize „Å® groupSize „Çí .estimated „Å´„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
    func makeLayoutSection_note1() -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
//            heightDimension: .fractionalHeight(1.0) // üôÖ‚Äç‚ôÄÔ∏è
            heightDimension: .estimated(100.0) // üôÜ‚Äç‚ôÄÔ∏è
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let itemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let itemGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: itemGroupSize,
            subitem: item,
            count: 1
        )
        
        let section = NSCollectionLayoutSection(group: itemGroup)
        section.contentInsets = .init(
            top: 16.0,
            leading: 16.0,
            bottom: 16.0,
            trailing: 16.0
        )
        section.interGroupSpacing = 8.0
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    /// „ÅØ„Åæ„Çä„Å©„Åì„ÇçÔºí: „Ç∞„É´„Éº„Éó„Çí UICollectionView „ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÊñπÂêë„Å®Âêå„ÅòÊñπÂêë„Åß count „ÇíÊåáÂÆö„Åó„Å¶‰Ωú„Çã„Å® Self-Sizing „Åï„Çå„Å™„ÅÑ
    func makeLayoutSection_note2() -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let itemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
//        let itemGroup = NSCollectionLayoutGroup.vertical( // üôÖ‚Äç‚ôÄÔ∏è
        let itemGroup = NSCollectionLayoutGroup.horizontal( // üôÜ‚Äç‚ôÄÔ∏è„Åù„ÅÆÔºë
            layoutSize: itemGroupSize,
            subitem: item,
            count: 1
        )
//        let itemGroup = NSCollectionLayoutGroup.vertical( // üôÜ‚Äç‚ôÄÔ∏è„Åù„ÅÆÔºí
//            layoutSize: itemGroupSize,
//            subitems: [item],
//        )
        
        let section = NSCollectionLayoutSection(group: itemGroup)
        section.contentInsets = .init(
            top: 16.0,
            leading: 16.0,
            bottom: 16.0,
            trailing: 16.0
        )
        section.interGroupSpacing = 8.0
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    /// „ÅØ„Åæ„Çä„Å©„Åì„ÇçÔºì: „É¨„Ç§„Ç¢„Ç¶„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆ Self-Sizing ÊñπÂêë„ÅÆ contentInsets „ÅåÂäπ„Åã„Åö„ÄÅÂûÇÁõ¥ÊñπÂêë„ÅÆ contentInsets „ÅåË®≠ÂÆöÈÄö„Çä„Å´ÂèçÊò†„Åï„Çå„Å™„ÅÑ
    func makeLayoutSection_note3() -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        item.contentInsets = .init(
            top: 16.0, // Ë®≠ÂÆö„Åó„Å¶„ÇÇÂäπ„Åã„Å™„ÅÑ
            leading: 16.0, // Ë®≠ÂÆö„Åô„Çã„Å® leading, trailing „ÅÆ‰∏°Êñπ„Å´ÂèçÊò†„Åï„Çå„Çã
            bottom: 16.0, // Ë®≠ÂÆö„Åó„Å¶„ÇÇÂäπ„Åã„Å™„ÅÑ
            trailing: 16.0 // Ë®≠ÂÆö„Åô„Çã„Å® ÂÄ§ * 2 „Åå trailing „Å´ÂèçÊò†„Åï„Çå„Çã
        )
        
        let itemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let itemGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: itemGroupSize,
            subitem: item,
            count: 1
        )
        
        let section = NSCollectionLayoutSection(group: itemGroup)
        section.interGroupSpacing = 8.0
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    /// „ÅØ„Åæ„Çä„Å©„Åì„ÇçÔºî: „Ç∞„É´„Éº„Éó„ÅÆ Self-Sizing ÊñπÂêë„ÅÆ contentInsets „ÅåÂäπ„Åã„Å™„ÅÑ
    func makeLayoutSection_note4() -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let itemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let itemGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: itemGroupSize,
            subitem: item,
            count: 1
        )
        itemGroup.contentInsets = .init(
            top: 16.0, // Ë®≠ÂÆö„Åó„Å¶„ÇÇÂäπ„Åã„Å™„ÅÑ
            leading: 16.0, // Ë®≠ÂÆöÈÄö„Çä„Å´ÂèçÊò†„Åï„Çå„Çã
            bottom: 16.0, // Ë®≠ÂÆö„Åó„Å¶„ÇÇÂäπ„Åã„Å™„ÅÑ
            trailing: 16.0 // Ë®≠ÂÆöÈÄö„Çä„Å´ÂèçÊò†„Åï„Çå„Çã
        )
        
        let section = NSCollectionLayoutSection(group: itemGroup)
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }

    /// „É¨„Ç§„Ç¢„Ç¶„Éà‰æãÔºë: Á∏¶ÊñπÂêë„Å´„Çπ„ÇØ„É≠„Éº„É´„Åô„Çã UICollectionView „ÅßÂêå„Åò item „ÇíÁ∏¶„Å´Ë§áÊï∞‰∏¶„Åπ„Çã
    func makeLayoutSection_example1() -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let item = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let itemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let itemGroup = NSCollectionLayoutGroup.vertical(
            layoutSize: itemGroupSize,
            subitems: [item]
        )
        itemGroup.contentInsets = .init(
            top: .zero,
            leading: 16.0,
            bottom: .zero,
            trailing: 16.0
        )

        let section = NSCollectionLayoutSection(group: itemGroup)
        section.contentInsets = .init(
            top: 16.0,
            leading: .zero,
            bottom: 16.0,
            trailing: .zero
        )
        section.interGroupSpacing = 8.0
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    /// „É¨„Ç§„Ç¢„Ç¶„Éà‰æãÔºí: Á∏¶ÊñπÂêë„Å´„Çπ„ÇØ„É≠„Éº„É´„Åô„Çã UICollectionView „ÅßÁï∞„Å™„Çã„É¨„Ç§„Ç¢„Ç¶„Éà„Ç¢„Ç§„ÉÜ„É†„ÇíÁ∏¶„Å´Ë§áÊï∞‰∏¶„Åπ„Å¶ Self-Sizing „Åï„Åõ„Çã
    func makeLayoutSection_example2_1() -> NSCollectionLayoutSection {
        let interItemSpacing: NSCollectionLayoutSpacing = .fixed(8.0)

        // MARK: - Large Item
        let largeItemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let largeItem = NSCollectionLayoutItem(layoutSize: largeItemSize)
        
        let largeItemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(300.0)
        )
        let largeItemGroup = NSCollectionLayoutGroup.vertical(
            layoutSize: largeItemGroupSize,
            subitems: [largeItem, largeItem, largeItem]
        )
        largeItemGroup.contentInsets = .init(
            top: .zero,
            leading: 16.0,
            bottom: .zero,
            trailing: 16.0
        )
        largeItemGroup.interItemSpacing = interItemSpacing
        
        // MARK: - Small Item
        let smallItemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let smallItem = NSCollectionLayoutItem(layoutSize: smallItemSize)
        
        let smallItemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let smallItemGroup = NSCollectionLayoutGroup.vertical(
            layoutSize: smallItemGroupSize,
            subitems: [smallItem, smallItem]
        )
        smallItemGroup.contentInsets = .init(
            top: .zero,
            leading: 48.0,
            bottom: .zero,
            trailing: 48.0
        )
        smallItemGroup.interItemSpacing = interItemSpacing
        
        // MARK: - All
        let groupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(500.0)
        )
        let group = NSCollectionLayoutGroup.vertical(
            layoutSize: groupSize,
            subitems: [
                largeItemGroup,
                smallItemGroup
            ]
        )
        group.interItemSpacing = interItemSpacing
        
        let section = NSCollectionLayoutSection(group: group)
        section.contentInsets = .init(
            top: 16.0,
            leading: .zero,
            bottom: 16.0,
            trailing: .zero
        )
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    /// „É¨„Ç§„Ç¢„Ç¶„Éà‰æãÔºí: Á∏¶ÊñπÂêë„Å´„Çπ„ÇØ„É≠„Éº„É´„Åô„Çã UICollectionView „ÅßÁï∞„Å™„Çã„É¨„Ç§„Ç¢„Ç¶„Éà„Ç¢„Ç§„ÉÜ„É†„ÇíÁ∏¶„Å´Ë§áÊï∞‰∏¶„Åπ„Å¶ Self-Sizing „Åï„Åõ„Çã
    func makeLayoutSection_example2_2() -> NSCollectionLayoutSection {
        // MARK: - Large Item
        let largeItemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let largeItem = NSCollectionLayoutItem(layoutSize: largeItemSize)
        
        let largeItemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let largeItemGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: largeItemGroupSize,
            subitem: largeItem,
            count: 1
        )
        largeItemGroup.contentInsets = .init(
            top: .zero,
            leading: 16.0,
            bottom: .zero,
            trailing: 16.0
        )
        
        // MARK: - Small Item
        let smallItemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let smallItem = NSCollectionLayoutItem(layoutSize: smallItemSize)
        
        let smallItemGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(100.0)
        )
        let smallItemGroup = NSCollectionLayoutGroup.horizontal(
            layoutSize: smallItemGroupSize,
            subitem: smallItem,
            count: 1
        )
        smallItemGroup.contentInsets = .init(
            top: .zero,
            leading: 48.0,
            bottom: .zero,
            trailing: 48.0
        )
        
        // MARK: - All
        let groupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1.0),
            heightDimension: .estimated(500.0)
        )
        let group = NSCollectionLayoutGroup.vertical(
            layoutSize: groupSize,
            subitems: [
                largeItemGroup, largeItemGroup, largeItemGroup,
                smallItemGroup, smallItemGroup
            ]
        )
        group.interItemSpacing = .fixed(8.0)
        
        let section = NSCollectionLayoutSection(group: group)
        section.contentInsets = .init(
            top: 16.0,
            leading: .zero,
            bottom: 16.0,
            trailing: .zero
        )
        section.decorationItems = [makeBackgroundColorDecorationItem()]
        return section
    }
    
    func makeBackgroundColorDecorationItem() -> NSCollectionLayoutDecorationItem {
        .background(elementKind: BackgroundColorView.kind)
    }
}
// Present the view controller in the Live View window
PlaygroundPage.current.liveView = MyViewController()

